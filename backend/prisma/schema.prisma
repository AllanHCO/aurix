// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                 String   @id @default(uuid())
  email              String   @unique
  senha              String
  nome               String?
  agenda_slug        String?  @unique
  nome_organizacao   String?
  nome_unidade       String?
  logo_url           String?
  cor_primaria_hex   String?
  status_operacao    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  vendas                  Venda[]
  agendamentos            Agendamento[]
  bloqueios                Bloqueio[]
  configuracao_agenda     ConfiguracaoAgenda?
  disponibilidade_semanal DisponibilidadeSemanal[]
  company_settings        CompanySettings?

  @@map("usuarios")
}

enum PlanoTipo {
  FREE
  TRIAL
  PAID
}

model CompanySettings {
  usuario_id                    String    @id
  dias_atencao                  Int       @default(30)
  dias_inativo                  Int       @default(45)
  msg_whatsapp_atencao          String?   @db.Text
  msg_whatsapp_inativo          String?   @db.Text
  msg_whatsapp_pos_venda        String?   @db.Text
  msg_whatsapp_confirmacao_agenda String? @db.Text
  msg_whatsapp_lembrete_agenda  String?   @db.Text
  plano                         PlanoTipo @default(FREE)
  trial_ends_at                 DateTime? @db.Date
  is_active                     Boolean   @default(true)
  blocked_reason                String?   @db.VarChar(500)
  meta_faturamento_mes          Decimal?  @db.Decimal(12, 2)
  is_demo                       Boolean   @default(false)
  updatedAt                     DateTime  @updatedAt

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("company_settings")
}

model DemoEntity {
  id          String   @id @default(uuid())
  usuario_id  String
  entity_type String   // 'cliente' | 'categoria' | 'produto' | 'venda' | 'agendamento' | 'bloqueio'
  entity_id   String

  @@unique([usuario_id, entity_type, entity_id])
  @@index([usuario_id])
  @@map("demo_entities")
}

model Categoria {
  id        String   @id @default(uuid())
  nome      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  produtos Produto[]

  @@map("categorias")
}

model Produto {
  id              String   @id @default(uuid())
  nome            String
  preco           Decimal  @db.Decimal(10, 2)
  custo           Decimal  @db.Decimal(10, 2)
  estoque_atual   Int      @default(0)
  estoque_minimo  Int      @default(0)
  categoria_id    String
  linha           String?  // agrupamento opcional (ex: linha de produto)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  categoria  Categoria   @relation(fields: [categoria_id], references: [id])
  itensVenda ItemVenda[]

  @@unique([nome, categoria_id])
  @@index([categoria_id])
  @@index([estoque_atual])
  @@map("produtos")
}

enum ClienteStatus {
  ativo
  atencao
  inativo
}

model Cliente {
  id        String        @id @default(uuid())
  nome      String
  telefone  String?
  observacoes String?     @db.Text
  status    ClienteStatus @default(ativo)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  vendas Venda[]

  @@map("clientes")
}

model Venda {
  id              String      @id @default(uuid())
  cliente_id      String
  usuario_id      String
  total           Decimal     @db.Decimal(10, 2)
  desconto        Decimal     @default(0) @db.Decimal(10, 2)
  forma_pagamento String
  status          VendaStatus @default(PENDENTE)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  cliente Cliente   @relation(fields: [cliente_id], references: [id])
  usuario Usuario   @relation(fields: [usuario_id], references: [id])
  itens   ItemVenda[]

  @@index([status, createdAt])
  @@index([usuario_id, status, cliente_id])
  @@index([usuario_id, status, createdAt])
  @@index([usuario_id, createdAt])
  @@map("vendas")
}

model ItemVenda {
  id             String   @id @default(uuid())
  venda_id      String
  produto_id    String
  quantidade    Int
  preco_unitario Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())

  venda   Venda   @relation(fields: [venda_id], references: [id], onDelete: Cascade)
  produto Produto @relation(fields: [produto_id], references: [id])

  @@index([produto_id, venda_id])
  @@index([venda_id])
  @@index([produto_id])
  @@map("itens_venda")
}

enum VendaStatus {
  PAGO
  PENDENTE
  FECHADA
}

// ---- Agendamentos (V1) ----

model ConfiguracaoAgenda {
  usuario_id                 String  @id
  hora_inicio_funcionamento  String  // "08:00" (fallback quando não há disponibilidade_semanal)
  hora_fim_funcionamento     String  // "18:00"
  duracao_padrao_minutos     Int     // 30
  buffer_minutos             Int     // 10
  antecedencia_minima_dias   Int     // 2
  limite_maximo_dias         Int     // 30
  servico_padrao_nome        String? // "Corte de Cabelo & Barba" (opcional, para resumo público)

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("configuracao_agenda")
}

model DisponibilidadeSemanal {
  id          String   @id @default(uuid())
  usuario_id  String
  dia_semana  Int      // 0=dom, 1=seg, ..., 6=sab
  ativo       Boolean  @default(true)
  hora_inicio String   // "08:00"
  hora_fim    String   // "18:00"

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@unique([usuario_id, dia_semana])
  @@index([usuario_id])
  @@map("disponibilidade_semanal")
}

enum AgendamentoStatus {
  PENDENTE
  CONFIRMADO
  CANCELADO
}

model Agendamento {
  id               String            @id @default(uuid())
  usuario_id       String
  nome_cliente     String
  telefone_cliente String
  observacao       String?           @db.Text
  data             DateTime         @db.Date
  hora_inicio      String            // "09:00"
  hora_fim         String            // "09:30"
  status           AgendamentoStatus @default(PENDENTE)
  checkin_at       DateTime?        // quando fez check-in (compareceu)
  no_show          Boolean          @default(false) // não compareceu
  createdAt        DateTime         @default(now())

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id, data])
  @@index([usuario_id, data, hora_inicio, status])
  @@map("agendamentos")
}

enum BloqueioTipo {
  RECORRENTE
  INTERVALO_DATA
}

model Bloqueio {
  id          String       @id @default(uuid())
  usuario_id  String
  tipo        BloqueioTipo
  dia_semana  Int?         // 0-6 (domingo=0), para RECORRENTE
  data_inicio DateTime?    @db.Date // para INTERVALO_DATA
  data_fim    DateTime?    @db.Date
  hora_inicio String?      // "08:00"
  hora_fim    String?      // "15:00"
  createdAt   DateTime    @default(now())

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([usuario_id, tipo])
  @@map("bloqueios")
}
